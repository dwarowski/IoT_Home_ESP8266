# Умный дом на ESP8266 с использованием WQTT

Этот проект представляет собой систему управления умным домом, реализованную на базе микроконтроллера ESP8266 и использующую брокер MQTT (WQTT).  Он позволяет контролировать различные устройства и датчики в доме, такие как освещение, температуру, влажность, окна, кондиционер, а также обеспечивает функции безопасности.

## Особенности

•   **Подключение к MQTT брокеру WQTT:**  Использует MQTT для обмена данными между ESP8266 и системой управления (например, веб-интерфейсом или мобильным приложением).
•   **Управление освещением:**  Контроль внутреннего и наружного освещения, с возможностью диммирования. Автоматическое включение света по датчику движения (внутри) и освещенности (снаружи).
•   **Мониторинг температуры и влажности:**  Считывание данных с датчика DHT11 и отправка на MQTT брокер.
•   **Управление окнами:**  Автоматическое открытие/закрытие окна на основе показаний датчика влажности или ручного управления через MQTT.
•   **Управление кондиционером:**  Регулировка температуры и включение/выключение кондиционера через MQTT.
•   **Управление вытяжкой:** Включение/выключение вытяжки через MQTT и автоматически при превышении порога влажности.
•   **Детектор дыма:**  Отправка уведомлений при обнаружении газа (имитация детектора дыма).
•   **Детектор протечки воды:** Отправка уведомлений при обнаружении протечки.
•   **Система безопасности:**  Режим охраны с использованием датчика движения. Отправка уведомлений при обнаружении движения в режиме охраны.

## Аппаратное обеспечение

•   [x] ESP8266 (например, NodeMCU или Wemos D1 Mini)
•   [x] DHT11 (датчик температуры и влажности)
•   [x] Датчик движения (PIR)
•   [x] Датчик газа (MQ-2 или аналогичный)
•   [x] Фоторезистор (датчик освещенности)
•   [x] Датчик протечки воды
•   [x] Сервопривод (для управления окном)
•   [x] Реле или MOSFET (для управления освещением, кондиционером, вытяжкой) - *Примечание: Требуется для управления нагрузкой 220В.  Для управления маломощными устройствами можно использовать напрямую пины ESP8266 (не рекомендуется).*
•   [x] Резисторы (для датчиков и делителей напряжения)
•   [ ] Макетная плата и провода для соединений (опционально)

## Схема подключения
ESP8266  | Компонент     |
-----------|-------------------|
D4     | DHT11 (Data)   |
D2     | Датчик движения  |
D6     | Датчик газа    |
D0     | Датчик освещенности |
TX     | Датчик протечки  |
D5     | Реле (Свет)    |
RX     | Реле (Уличный свет)|
D1     | Сервопривод (Окно) |
D7     | Реле (Вытяжка)  |
D8     | Реле (Кондиционер)|
```

Важно: Убедитесь, что правильно подключили все компоненты, особенно датчики. Неправильное подключение может привести к повреждению оборудования. Особенно важно использовать реле/МОП-транзисторы для управления нагрузкой 220В! Прямое подключение к пинам ESP8266 может повредить микроконтроллер и/или создать опасную ситуацию.

▌Программное обеспечение

•  Arduino IDE
•  Библиотеки:
  •  PubSubClient (для MQTT)
  •  ESP8266WiFi (для WiFi)
  •  DHT (для датчика DHT11)
  •  Servo (для сервопривода)
•  Брокер MQTT: WQTT (server.wqtt.ru:12345)

▌Инструкция по установке

1. Установите Arduino IDE: Скачайте и установите Arduino IDE с официального сайта: https://www.arduino.cc/en/software
2. Установите ESP8266 Board Package:
  •  Откройте Arduino IDE и перейдите в File -> Preferences.
  •  В поле Additional Boards Manager URLs добавьте: http://arduino.esp8266.com/stable/package_esp8266com_index.json
  •  Перейдите в Tools -> Board -> Boards Manager.
  •  Найдите esp8266 и установите последнюю версию.
3. Установите необходимые библиотеки:
  •  Откройте Arduino IDE и перейдите в Sketch -> Include Library -> Manage Libraries.
  •  Найдите и установите следующие библиотеки:
    *  PubSubClient by Nick O'Leary
    *  DHT sensor library by Adafruit
    *  Servo by Arduino
4. Склонируйте репозиторий: Скачайте код проекта с GitHub.
5. Настройте код:
  •  Откройте файл *.ino в Arduino IDE.
  •  Замените следующие значения на свои:
    *  ssid - Имя вашей WiFi сети.
    *  pass - Пароль вашей WiFi сети.
    *  mqtt_server - Адрес MQTT брокера (server.wqtt.ru).
    *  mqtt_port - Порт MQTT брокера (12345).
    *  mqtt_user - Логин для подключения к MQTT брокеру.
    *  mqtt_pass - Пароль для подключения к MQTT брокеру.
6. Выберите плату и порт:
  •  В Arduino IDE перейдите в Tools -> Board и выберите вашу плату ESP8266 (например, NodeMCU 1.0 (ESP-12E Module)).
  •  Перейдите в Tools -> Port и выберите COM-порт, к которому подключена ваша ESP8266.
7. Загрузите код: Нажмите кнопку Upload в Arduino IDE.

▌Конфигурация MQTT

•  Топики для публикации (ESP8266 -> MQTT):
  •  temperature_sensor_value_topic: Температура (в градусах Цельсия).
  •  humidity_sensor_value_topic: Влажность (в процентах).
  •  gas_web_value_topic: Состояние датчика газа (0 или 1).
  •  water_sensor_value_topic: Состояние датчика протечки воды (0 или 1).
  •  security_sensor_value_topic: Состояние охраны (0 или 1).

•  Топики для подписки (MQTT -> ESP8266):
  •  light_web_value_topic: Яркость внутреннего освещения (0-255).
  •  outside_light_web_value_topic: Яркость уличного освещения (0-255).
  •  window_web_value_topic: Положение окна (0-180 градусов).
  •  AC_web_value_topic: Температура кондиционера.
  •  AC_web_value_topic2: Состояние кондиционера (0 - выключен, 1 - включен).
  •  airing_web_value_topic: Состояние вытяжки (0 - выключена, 1 - включена).
  •  security_web_value_topic: Состояние охраны (0 - выключена, 1 - включена).

▌Использование

После успешной загрузки кода на ESP8266, устройство подключится к вашей WiFi сети и MQTT брокеру. Вы можете использовать MQTT клиент (например, MQTT Explorer) для просмотра и управления устройствами.

1. Мониторинг: Подпишитесь на топики для публикации, чтобы видеть данные с датчиков.
2. Управление: Публикуйте сообщения в топики для подписки, чтобы управлять освещением, окнами, кондиционером и другими устройствами.

▌Логика работы

В основном цикле loop() выполняются следующие действия:

1. Подключение к MQTT: Проверка и переподключение к MQTT брокеру, если соединение потеряно.
2. Чтение датчиков: Считывание данных с датчиков температуры, влажности, движения, газа, освещенности и протечки воды.
3. Публикация данных: Отправка данных с датчиков на MQTT брокер.
4. Логика управления:
  •  Освещение: Автоматическое включение/выключение света по датчику движения и/или ручное управление через MQTT.
  •  Уличное освещение: Автоматическое включение/выключение в зависимости от освещенности.
  •  Окно: Автоматическое открытие/закрытие в зависимости от влажности или ручное управление.
  •  Кондиционер: Управление кондиционером через MQTT.
  •  Вытяжка: Включение/выключение вытяжки в зависимости от влажности или ручное управление.
  •  Система безопасности: Контроль движения при включенном режиме охраны.
  •  Детектор дыма: Отправляет сообщение на сервер при срабатывании датчика.
  •  Детектор протечки воды: Отправляет сообщение на сервер при срабатывании датчика.

▌Планы по развитию

•  Добавить поддержку других датчиков и устройств.
•  Реализовать более сложные сценарии автоматизации, например, управление отоплением.
•  Интеграция с другими системами умного дома (Home Assistant, OpenHAB).
•  Создание веб-интерфейса для управления и мониторинга (например, на базе Node-RED или Flask).

▌Благодарности

•  Библиотекам PubSubClient, ESP8266WiFi, DHT, Servo.
•  Сообществу разработчиков ESP8266.
•  Разработчикам брокера WQTT за предоставленную платформу.

▌Лицензия

MIT License

```
